name: "SBOM Generation"

on:
  push:
    branches: [ "main" ]
    tags: [ "v*" ]
  release:
    types: [ published ]
  workflow_dispatch:

jobs:
  generate-sbom:
    name: Generate SBOM
    runs-on: ubuntu-latest
    timeout-minutes: 15
    permissions:
      contents: write
      security-events: write

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python 3.13
      uses: actions/setup-python@v5
      with:
        python-version: "3.13"
        cache: pip

    - name: Install dependencies and build tools
      run: |
        python -m pip install --upgrade pip
        pip install cyclonedx-bom[requirements]
        pip install -e .
        pip install -r config/dependencies/requirements.lock

    - name: Generate CycloneDX SBOM from requirements
      run: |
        echo "üìã Generating SBOM from requirements..."
        cyclonedx-py requirements \
          --requirements-file config/dependencies/requirements.lock \
          --output-format json \
          --output-file sbom-requirements.json \
          --schema-version 1.5

        echo "üìã Generating SBOM from environment..."
        cyclonedx-py environment \
          --output-format json \
          --output-file sbom-environment.json \
          --schema-version 1.5

        echo "üìã Generated SBOMs:"
        ls -la sbom-*.json

    - name: Validate SBOM files
      run: |
        echo "üîç Validating SBOM files..."
        for sbom in sbom-*.json; do
          echo "Validating $sbom"
          # Basic JSON validation
          jq empty "$sbom" && echo "‚úÖ $sbom is valid JSON"
          # Check required CycloneDX fields
          jq -e '.bomFormat == "CycloneDX"' "$sbom" && echo "‚úÖ $sbom has correct format"
          jq -e '.specVersion' "$sbom" && echo "‚úÖ $sbom has spec version"
          jq -e '.components[]?' "$sbom" && echo "‚úÖ $sbom has components"
        done

    - name: Generate SBOM summary
      run: |
        echo "üìä SBOM Summary:" | tee sbom-summary.txt
        echo "==============" | tee -a sbom-summary.txt
        echo "" | tee -a sbom-summary.txt
        for sbom in sbom-*.json; do
          echo "File: $sbom" | tee -a sbom-summary.txt
          echo "Components: $(jq '[.components[]?] | length' "$sbom")" | tee -a sbom-summary.txt
          echo "Spec Version: $(jq -r '.specVersion' "$sbom")" | tee -a sbom-summary.txt
          echo "Generated: $(jq -r '.metadata.timestamp' "$sbom")" | tee -a sbom-summary.txt
          echo "" | tee -a sbom-summary.txt
        done

        echo "üîç Direct dependencies:"
        jq -r '.components[]? | select(.scope == "required") | .name' sbom-requirements.json | sort | head -20

    - name: Upload SBOM artifacts
      uses: actions/upload-artifact@v4
      with:
        name: sbom-files
        path: |
          sbom-*.json
          sbom-summary.txt
        retention-days: 90

    # Upload to release assets if this is a release
    - name: Upload SBOM to release
      if: startsWith(github.ref, 'refs/tags/v')
      uses: softprops/action-gh-release@v1
      with:
        files: |
          sbom-*.json
          sbom-summary.txt
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    # Create security advisory if vulnerabilities found
    - name: Check for vulnerabilities in SBOM
      run: |
        echo "üîç Checking SBOM for known vulnerability patterns..."

        # Check for components with known vulnerability indicators
        vulnerable_components=$(jq -r '.components[]? | select(.vulnerabilities[]? or .evidence?.identity[]?.confidence < 0.8) | .name' sbom-requirements.json 2>/dev/null || echo "")

        if [ ! -z "$vulnerable_components" ]; then
          echo "‚ö†Ô∏è Components with potential vulnerability concerns found:"
          echo "$vulnerable_components"
          echo "Please review the SBOM and run additional vulnerability scans."
        else
          echo "‚úÖ No obvious vulnerability indicators in SBOM components"
        fi

    - name: Generate SBOM attestation
      run: |
        echo "üìú Generating SBOM attestation..."
        cat > sbom-attestation.json << 'EOF'
        {
          "attestation": {
            "type": "https://slsa.dev/provenance/v1",
            "subject": [
              {
                "name": "finos-ai-governance-mcp-server",
                "digest": {
                  "sha256": ""
                }
              }
            ],
            "predicate": {
              "buildType": "https://github.com/actions/runner",
              "builder": {
                "id": "https://github.com/actions/runner"
              },
              "invocation": {
                "configSource": {
                  "uri": "${{ github.repository }}",
                  "digest": {
                    "sha1": "${{ github.sha }}"
                  }
                }
              },
              "metadata": {
                "buildInvocationId": "${{ github.run_id }}",
                "completeness": {
                  "parameters": true,
                  "environment": true,
                  "materials": true
                },
                "reproducible": false
              },
              "materials": [
                {
                  "uri": "git+${{ github.repository }}@${{ github.ref }}",
                  "digest": {
                    "sha1": "${{ github.sha }}"
                  }
                }
              ]
            }
          }
        }
        EOF
        echo "‚úÖ SBOM attestation generated"
